# 2. 核心概念
HomeKit配件细明定义了支持HAP(HomeKit Accessory Protocol)配件如何与Apple设备通信。例如，一个iOS设备如何发现、探测和与配件交互，比如灯泡、门锁和车库门开启装置。
### 2.1 传输
HomeKit配件协议支持两种数据传输方式：蓝牙LE和IP。HomeKit配件可能支持种或两种方式。具体的传输协议在[第六章]()和[第七章]()讨论。
### 2.2 安全
HomeKit配件协议的会话是端到端加密并且有相互验证。回话还具有完美的向前保密性，意味着每一个会话都会生成一个新的、唯一的key。这个功能由配对提供。
#### 2.2.1 配对
配对在iOS设备和配件之间提供一个加密的关系。配对由两个部分组成：配对设置和配对验证。
##### 2.2.1.1 配对设置
配对设置是一种一次性操作。通过安全的交换共钥，在iOS设备和配件之间建立有效的配对。配对设置要求客户在iOS设备上输入一个8位的代码。这个代码由配件的标签或二维码提供。
##### 2.2.1.2 配对验证
对每个HomeKit 附件协议会话执行配对验证。配对验证验证 iOS 设备和配件之间的配对，并建立用于保护 HomeKit配件协议会话的临时共享密钥。
#### 2.2.3 会话密钥
加密和身份验证密钥源自配对验证期间建立的临时共享秘密。
### 2.3 属性
HomeKit配件协议使用两种属性：服务和特征。来描述配件的功能。
#### 2.3.1 配件
配件由服务和特征构成。例如，一个配件是带有灯和喷洒冷水的喷雾器的吊扇。
#### 2.3.2 服务
服务组功能用来提供上下文。在上述示例附件中，有三个服务：与吊扇交互的风扇服务、与灯交互的灯服务、与喷雾器交互的喷雾服务。
##### 2.3.2.1 服务名称
并非所有服务都提供用户可见或用户交互的功能。提供用户可见或用户交互功能的服务必须包含名称特征。所有其他服务不得包含此特征。iOS 控制器使用此约定来确定向用户显示哪些服务。  
在上述吊扇示例中，风扇、灯光和先生服务都将包含 Name 特征。也可能有提供固件更新功能的附加服务，此服务中包含的特征并不意味着用户可见或用户可交互，因此此服务将不包含名称特征。  
请注意，附件信息服务(8.1附件信息)是一个例外，并且始终包含 Name 特征，即使它通常不是用户可见或用户交互的。
##### 2.3.2.2 扩展服务
保持与早期客户端的向后兼容性，在服务的更高版本中添加的任何特征都必须是可选的。服务的更高版本不得更改服务的先前版本中定义的行为。
##### 2.3.2.3 主要服务
配件应将其服务之一列为主要服务。主要服务必须与配件的主要功能相匹配，并且还必须与配件类别相匹配。附件必须仅公开其可用服务列表中的仅一项主要服务。
##### 2.3.2.4 隐藏服务
配件可以指定通过通用 HomeKit 应用程序对用户隐藏的服务。配件可能会公开多个服务。可用于配置配件或更新配件上的固件的服务应标记为隐藏。当服务中的所有特征都标记为隐藏时，该服务也必须标记为隐藏。
##### 2.3.2.4 链接服务
链接服务允许配件指定服务之间的逻辑关系。一项服务可以链接到一项或多项服务。服务不得链接到自身。服务链接仅对其链接到的第一级服务具有上下文和意义。例如，如果服务 A 链接到服务 B，而服务 B 链接到服务 C，这并不意味着服务 A 与服务 C 之间存在任何关系。如果服务 A 还与服务 C 相关，则服务 A 的链接服务必须同时包括服务 B 和服务 C。链接服务允许应用程序在 UI 中显示逻辑分组的附件控件。
#### 2.3.3 特征
特征是表示数据或服务相关行为的特性。特征由通用唯一类型定义，并具有确定方法访问特征值的附加属性。
* perms 和 ev 属性。例如，指示读/写/通知权限和事件通知。
* 该特征可能还有其他属性可以进一步描述该特征。类似格式的属性描述了特征值的格式，例如 int 或 string，description 包含一个描述字符串，而 minValue、maxValue 和 minStep 指的是也适用于特征值的最小值、最大值和步长限制。
* 例如，“8.23LightBulb”（第 147 页）服务包含“9.11Brightness”（第 162 页）类型为 public.hap.characteristic.brightness 的特性，具有配对读取 (pr) 和配对写入 (pw) 权限。ʼ“9.11 亮度”（第 162 页）特性可能具有描述该值的附加属性。例如，格式属性可以指示值是整数，而单位属性可以指示值是百分比。此外，其他属性可用于通过 minValue、maxValue 和 minStep 属性指示最小值为 0、最大值为 100 和步长值为 1。
一个特性可能适用于许多不同的服务。在上述示例配件中，灯泡服务可能具有以下特征：
* “9.70On”（第 191 页）：此特性是代表灯的功率状态的布尔值：真值表示灯已打开，假值表示灯已关闭。
* “9.11 亮度”（第 162 页）：此特性是一个整数值，用于描述灯泡的感知亮度，表示为支持的最大亮度级别的百分比。
* “9.44Hue”（第 179 页）：此特性标识灯泡的色调或颜色。
* “9.62Name”（第 188 页）：此特征是标识灯泡名称的字符串值。
* “9.82 饱和度”（第 197 页）：该特性将灯泡的颜色饱和度描述为
最大颜色饱和度的百分比。
* “9.21 色温”（第 167 页）：该特性描述了以倒数兆开尔文 (MK-1) 或米雷克标度表示的色温。 （M = 1,000,000 / K，其中 M 是所需的 mirek 值，K 是以开尔文为单位的温度）。
“8.38 Switch”（第 153 页）服务可能具有以下特征：
* “9.70 On”（第 191 页）：该特性是一个布尔值，表示开关的电源状态
true 值表示开关打开，false 值表示开关关闭。
* “9.62Name”（第 188 页）：该特性是标识开关名称的字符串值。
请注意，“9.70 On”（第 191 页）和“9.62 Name”（第 188 页）特性都可以定义灯泡和开关服务。 iOS 设备和配件之间的协议级交互是相同的，但服务为特征提供了上下文。
##### 2.3.3.1 有效的特征值
仅支持 Apple 定义的枚举值子集的附件特征可以将支持的值指示为特征元数据的一部分。
##### 2.3.3.1 附加授权数据
默认情况下，某些类型的特征可能支持写入请求的附加授权数据。附加授权数据是控制器提供的数据，附件可以使用这些数据来验证控制器是否有权执行请求的操作。授权数据的内容是制造商特定的。附加授权数据由配件应用程序（由配件制造商提供的用于控制或配置配件的 iOS 应用程序）提供给 iOS，并由 iOS 存储在控制器上。每个写入请求的附加授权数据不能是唯一的，因为控制器不会为每个请求构造或接收唯一的授权数据。额外的授权数据可能会定期更改。例如每月一次，或者当用户权限改变时。  
  
  
默认支持附加授权数据的特性和服务组合是“8.16车库门开启器”（第142页）中的“9.118目标门状态”（第229页）和“9.56锁定目标状态”（第186页）中的“9.56锁定目标状态”（第186页） 8.16 车库门开启器”（第 142 页）和“8.26 锁定机构”（第 148 页）。  
  
例如，实现外部锁的 HomeKit 配件（参见“8.26 锁机制”（第 148 页））可能希望允许家庭的所有主要用户随时控制锁。这个用户组有额外的授权数据ʼAʼ。另一组次要用户只允许在一天中的特定时间控制锁，例如上午 9 点到下午 6 点；这个用户组有额外的授权数据ʼBʼ。当主用户的控制器写入目标锁定状态“9.56 锁定目标状态”（第 186 页）时，控制器将包含附加授权数据 ʼAʼ 以及写入请求。锁可以根据包含额外的授权数据ʼAʼ来验证控制器是否被授权在一天中的任何时间执行写操作。但是，例如，如果次要用户的控制器尝试在晚上 10 点    00 点写入目标锁定状态，则该写入请求将包含额外的授权数据 ʼBʼ，然后附件可以拒绝写入，因为当时未授权基于包含额外的授权数据 ʼBʼ。
#### 2.3.4 其他 HomeKit 附件协议要求
以下是额外的 HomeKit 附件协议要求的总结
### 2.4 配置文件
配置文件定义了用于提供一致行为的适当服务和特征。例如，Light 配置文件使用“8.23 Light Bulb”（第 147 页），该特性需要“9.70 On”（第 191 页）特性。当“9.70 On”（第 191 页）设置为 false 值时，灯配置文件强制要求灯必须完全停止照明，从而使服务更进一步。
### 2.5 职责
#### 2.5.1 HAP客户端
* 永远是控制器
* 发送请求并接收来自 HAP 配服务器的响应。
* 注册并接收来自 HAP 配服务器的通知。
#### 2.5.2 HAP配件服务器
HAP 配服务器是一种支持 HomeKit 配协议并向 HAP 控制器公开一系列配的设备。一个 HAP 配件服务器代表与 HAP 配对建立的配对关系的一个端点，如“5 配对”（第 31 页）中所述，并公开至少一个 HAP 配对象。
* 永远是配件
* 公开HAP客户端可以访问的属性测试。
* 接受来自客户的传入请求并发送响应。
* 向注册的客户端发送通知。
#### 2.5.3 HAP 配件对象
HAP 附件对象表示 HAP 附件服务器上的物理附件。例如，恒温器将暴露一个代表恒温器用户可寻址功能的 HAP 附件对象。
##### 2.5.3.1 所需服务
一个 HAP 配件对象必须至少包含一项服务，public.hap.service.accessory-information，如“10。 Apple 定义的配置文件”（第 236 页）中所定义。
##### 2.5.3.2 桥接
桥接器是一种特殊类型的 HAP 附件服务器，可桥接 HomeKit 附件协议和不同的射频/传输协议，例如 Zigbee 或 Z-Wave。网桥必须将其连接的桥接端点支持的所有用户可寻址功能作为 HAP 附件对象公开给 HAP 控制器。网桥必须确保分配给代表其连接的桥接端点公开的 HAP 附件对象的实例 ID 在服务器/客户端配对的生命周期内不会更改。
例如，桥接三个灯的网桥将公开四个 HAP 附件对象：一个代表网桥本身的 HAP 附件对象，它可能包含固件更新服务，以及三个附加的 HAP 附件对象，每个对象都包含一个灯泡服务。  
一个桥接器不能暴露超过 150 个 HAP 附属对象。  
任何可以物理访问房屋的配件，无论是何种运输方式，例如门锁，都不得进行桥接。不得桥接支持 IP 传输的配件，例如 Wi-Fi。不得桥接支持可控制蓝牙 LE 的配件，例如灯泡。支持仅提供数据的蓝牙 LE 的配件（例如温度传感器）和支持其他传输的配件（例如 ZigBee 灯泡或专有 RF 传感器）可能会被桥接。
##### 2.5.3.3 主要 HAP 附件对象
实例 ID 为 1 的 HAP 附件对象被视为主要 HAP 附件对象。对于桥接器，这必须是桥接器本身。
##### 2.5.3.4 托管
包含在 HAP 附件对象中的服务必须并置。例如，一个带有灯的风扇将公开具有三个服务的单个 HAP 附件对象：必需的附件信息服务、风扇服务和灯泡服务。相反，桥接可能位于不同物理位置的两个独立灯的桥必须为每个独立灯暴露一个 HAP 附属对象。
### 2.6 配件属性数据库
附件属性数据库是 HAP 附件对象、服务对象和特征对象的列表。
#### 2.6.1 实例ID
IP 附件的实例 ID 是范围为 [1, 18446744073709551615] 的数字（请参阅“7.4.4.2 实例 ID”（第 122 页）了解 BLE 附件）。这些编号用于唯一标识 HAP 附件服务器内的 HAP 附件对象，或唯一标识 HAP 附件对象内的服务和特征。每个对象的实例 ID 在服务器/客户端配对的生命周期内必须是唯一的。
##### 2.6.1.1 配件实例ID
附件实例 ID，aid，是从整个 HAP 附件服务器全局的同一个号码池中分配的。例如，如果第一个附件对象的实例 ID 为“1”，则附件服务器中没有其他附件对象的实例 ID 为“1”。
##### 2.6.1.2 服务和特征实例 ID
服务和特性实例 ID，iid，是从同一个编号池分配的，该编号池在每个附件对象中都是唯一的。例如，如果第一个服务对象的实例 ID 为“1”，则在父附件对象中，没有其他服务或特征对象的实例 ID 为“1”。附件信息服务的服务实例 ID 必须为 1。  
  
固件更新后，保持不变的服务和特征类型必须保留其以前的实例 ID，新添加的服务和特征不得重复使用固件更新中删除的服务和特征的实例 ID。
